{%  extends 'docs/main.html' %}

{% block content %}


<body>
<textarea id="chat-log" cols="100" rows="20"></textarea><br>
{{ room_name|json_script:"room-name" }}
<script type="text/javascript">
    var user_name = "{{user_name}}";
    var online = [user_name];
    var viewed = {};
    var curr_user = {};
    viewed[user_name] = Date.now().toString();

    const roomName = JSON.parse(document.getElementById('room-name').textContent);

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/docs/'
        + roomName
        + '/'
    );

    chatSocket.onmessage = function (e) {
        // obtain info from message
        const data = JSON.parse(e.data);
        let name = data.message.name;
        let date = data.message[name];

        // insert new people
        if (!online.includes(name)) {
            online.push(name);
        }

        // update time-stamp
        viewed[name] = date;

        // remove

        document.querySelector('#chat-log').value += (online + ' ' + viewed[online] + '\n');
        console.log(viewed)
    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    window.setInterval(pingSocket, 1000);
    window.setInterval(removeIdle, 1000);

    function pingSocket() {
        curr_user[user_name] = new Date().toString();
        curr_user['name'] = user_name;
        chatSocket.send(JSON.stringify(curr_user));
    }


    function removeIdle() {
        for (index = 0; index < online.length; index++) {
            now = new Date().getTime();
            date = new Date(viewed[online[index]]).getTime();
            if (now - date > 10000) {
                online.splice(index, 1);
                console.log(online)
            }
        }
    }
</script>
</body>

{% endblock %}